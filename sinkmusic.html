<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SinkMusic - ì‹±í¬ ëª¨ìŒ</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .search-container {
            margin-bottom: 30px;
            text-align: center;
        }
        .search-dropdown {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px auto;
        }
        .select2-container--default .select2-selection--single {
            height: 50px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 18px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 46px;
            padding-left: 20px;
            color: #666;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 46px;
            right: 15px;
        }
        .select2-container--default.select2-container--focus .select2-selection--single {
            border-color: #ff0000;
        }
        .search-results {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 18px;
        }
        .song-block {
            margin-bottom: 40px;
            transition: opacity 0.3s;
        }
        .song-block.hidden {
            display: none;
        }
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-wrapper {
            text-align: center;
            position: relative;
        }
        .video-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .controls {
            text-align: center;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            background: #ff0000;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background: #cc0000;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-popup {
            background: #17a2b8;
        }
        .btn-popup:hover {
            background: #138496;
        }
        .sync-slider-container {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        .sync-slider-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .sync-slider {
            width: 95%;
            max-width: none;
            height: 12px;
            border-radius: 6px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            margin: 15px 0;
        }
        .sync-slider:hover {
            opacity: 1;
        }
        .sync-slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ff0000;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .sync-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ff0000;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .sync-value-display {
            font-size: 18px;
            font-weight: bold;
            color: #ff0000;
            margin: 10px 0;
        }
        .sync-description {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        @media (max-width: 768px) {
            .video-container {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-container">
            <select id="songSelect" class="search-dropdown">
                <option value="">ğŸ” ê³¡ì„ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”...</option>
            </select>
            <div id="searchResults" class="search-results">ê³¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
        </div>
        <div id="songs-area">
            <!-- ì„ íƒëœ ê³¡ì˜ UIê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
        </div>
        <div id="noResults" class="no-results" style="display: none;">
            ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.
        </div>
    </div>

    <script>
    // 1. ê³¡ ì •ë³´ ë°°ì—´ (ì—¬ê¸°ì— ê³¡ì„ ì¶”ê°€í•˜ë©´ ë¨)
    const songs = [
        {
            title: "ë§Œì°¬ê°€(G2B1)",
            guitarId: "bXmApI0Yojc",
            bassId: "xooA8RoU50g",
            delay: 8.1 // ì‹±í¬(ì´ˆ)
        }
        // ë‘ ë²ˆì§¸ ê³¡ì€ ì•„ë˜ì²˜ëŸ¼ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.
         ,{
            title: "í°ì„œíŠ¸(G4B1)",
            guitarId: "2sj0Q7XXmeU",
            bassId: "sMJvI1A3zgw",
            delay: 11.1
         }

         ,{
            title: "ë³„ì˜ í•˜ëª¨ë‹ˆ(G3B2)",
            guitarId: "L_iW3A0vZ_M",
            bassId: "MQBcx_AXtMs",
            delay: 7.5
         }

         ,{
            title: "ì˜¥íƒ‘ë°©(G2B2)",
            guitarId: "X0z0uFuCNcs",
            bassId: "_ovwU2gzx9A",
            delay: 8
         }

         ,{
            title: "ì—í”¼ì†Œë“œ(G4B2)",
            guitarId: "Fwdwf2Qkz54",
            bassId: "Rnha83fVUTU",
            delay: 7.2
         }

         ,{
            title: "ë‚™í™”(G4B3)",
            guitarId: "6DoA3L-Ifwg",
            bassId: "aem73t0x3d4",
            delay: 8
         }
    ];       

    // 2. ê³¡ë³„ í”Œë ˆì´ì–´, íŒì—…, ì‹±í¬ê°’ ê´€ë¦¬
    let currentPlayer = null; // í˜„ì¬ í‘œì‹œëœ ê³¡ì˜ í”Œë ˆì´ì–´
    let currentPopupWindows = {}; // í˜„ì¬ ê³¡ì˜ íŒì—…
    let currentOffsetSeconds = 0; // í˜„ì¬ ê³¡ì˜ ì‹±í¬ê°’
    let currentSongIdx = -1; // í˜„ì¬ ì„ íƒëœ ê³¡ ì¸ë±ìŠ¤

    // 3. ì„ íƒëœ ê³¡ë§Œ ë Œë”ë§
    function renderSelectedSong(idx) {
        const area = document.getElementById('songs-area');
        const song = songs[idx];
        
        // ê¸°ì¡´ í”Œë ˆì´ì–´ ì •ë¦¬
        if (currentPlayer) {
            try {
                if (currentPlayer.guitar) currentPlayer.guitar.destroy();
                if (currentPlayer.bass) currentPlayer.bass.destroy();
            } catch (error) {
                console.log('í”Œë ˆì´ì–´ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }
        
        // ê¸°ì¡´ íŒì—… ì •ë¦¬
        Object.keys(currentPopupWindows).forEach(type => {
            const popupData = currentPopupWindows[type];
            if (popupData && popupData.window && !popupData.window.closed) {
                popupData.window.close();
            }
        });
        
        // ìƒˆ ê³¡ UI ìƒì„±
        area.innerHTML = `
            <div class="song-block" id="current-song-block">
                <h2 style="text-align:center; color:#222; margin-bottom:18px;" id="current-song-title">${song.title}</h2>
                <div class="video-container">
                    <div class="video-wrapper">
                        <div class="video-title">ğŸ¸ ê¸°íƒ€ ì—°ì£¼</div>
                        <div id="current-guitar-player"></div>
                    </div>
                    <div class="video-wrapper">
                        <div class="video-title">ğŸµ ë² ì´ìŠ¤ ì—°ì£¼</div>
                        <div id="current-bass-player"></div>
                    </div>
                </div>
                <div class="sync-slider-container">
                    <div class="sync-slider-title">ğŸµ ì‹±í¬ ì¡°ì •</div>
                    <input type="range" id="syncSlider" class="sync-slider" 
                           min="0" max="12" step="0.1" value="${song.delay}">
                    <div class="sync-value-display" id="syncValue">${song.delay}ì´ˆ</div>
                    <div class="sync-description"><-ë² ì´ìŠ¤ê°€ ë¹¨ë¦¬ í‹€ì–´ì§ì„ ì˜ë¯¸</div>
                </div>
                <div class="controls">
                    <button class="btn btn-popup" onclick="openCurrentPopupWindow('guitar')" id="currentGuitarPopupBtn">ğŸ¸ ê¸°íƒ€ ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°</button>
                    <button class="btn" onclick="setCurrentSyncDelay()" id="currentSyncBtn">ì‹±í¬ ${song.delay}ì´ˆ ì ìš©</button>
                    <button class="btn" onclick="playCurrentBoth()" id="currentPlayBtn">â–¶ï¸ ë™ì‹œ ì¬ìƒ</button>
                    <button class="btn" onclick="stopCurrentBoth()" id="currentStopBtn">â¹ï¸ ì •ì§€</button>
                </div>
            </div>
        `;
        
        currentSongIdx = idx;
        currentOffsetSeconds = song.delay;
        currentPopupWindows = {};
        
        // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        setTimeout(() => {
            const slider = document.getElementById('syncSlider');
            const valueDisplay = document.getElementById('syncValue');
            
            if (slider && valueDisplay) {
                slider.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    currentOffsetSeconds = value;
                    valueDisplay.textContent = value + 'ì´ˆ';
                });
            }
        }, 100);
        
        // ìƒˆ í”Œë ˆì´ì–´ ìƒì„±
        setTimeout(() => {
            createCurrentPlayers(song);
        }, 100);
    }

    // í˜„ì¬ ê³¡ì˜ í”Œë ˆì´ì–´ ìƒì„±
    function createCurrentPlayers(song) {
        currentPlayer = {};
        currentPlayer.guitar = new YT.Player('current-guitar-player', {
            height: '315',
            width: '560',
            videoId: song.guitarId,
            playerVars: {
                'controls': 1,
                'modestbranding': 1,
                'rel': 0,
                'fs': 1
            }
        });
        currentPlayer.bass = new YT.Player('current-bass-player', {
            height: '315',
            width: '560',
            videoId: song.bassId,
            playerVars: {
                'controls': 1,
                'modestbranding': 1,
                'rel': 0,
                'fs': 1
            }
        });
        
        // ë²„íŠ¼ í™œì„±í™”
        setTimeout(() => {
            enableCurrentButtons(true);
        }, 1000);
    }

    // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    function initializeDropdown() {
        const select = $('#songSelect');
        
        // ëª¨ë“  ê³¡ì„ ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€
        songs.forEach((song, idx) => {
            select.append(`<option value="${idx}">${song.title}</option>`);
        });

        // Select2 ì´ˆê¸°í™”
        select.select2({
            placeholder: "ğŸ” ê³¡ì„ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”...",
            allowClear: true,
            width: '100%'
        });

        // ì„ íƒ ì´ë²¤íŠ¸ ì²˜ë¦¬
        select.on('change', function() {
            const selectedIdx = $(this).val();
            if (selectedIdx !== '') {
                // ì„ íƒëœ ê³¡ í‘œì‹œ
                renderSelectedSong(parseInt(selectedIdx));
                
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.textContent = `ì„ íƒëœ ê³¡: ${songs[selectedIdx].title}`;
                document.getElementById('noResults').style.display = 'none';
            } else {
                // ì„ íƒ í•´ì œ ì‹œ ëª¨ë“  ì˜ìƒ ì œê±°
                clearAllContent();
            }
        });
    }

    // ëª¨ë“  ì»¨í…ì¸  ì œê±°
    function clearAllContent() {
        const area = document.getElementById('songs-area');
        area.innerHTML = '';
        
        // í˜„ì¬ í”Œë ˆì´ì–´ ì •ë¦¬
        if (currentPlayer) {
            try {
                if (currentPlayer.guitar) currentPlayer.guitar.destroy();
                if (currentPlayer.bass) currentPlayer.bass.destroy();
            } catch (error) {
                console.log('í”Œë ˆì´ì–´ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            }
            currentPlayer = null;
        }
        
        // íŒì—… ì •ë¦¬
        Object.keys(currentPopupWindows).forEach(type => {
            const popupData = currentPopupWindows[type];
            if (popupData && popupData.window && !popupData.window.closed) {
                popupData.window.close();
            }
        });
        currentPopupWindows = {};
        
        currentSongIdx = -1;
        
        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.textContent = 'ê³¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
        document.getElementById('noResults').style.display = 'none';
    }

    // 4. ìœ íŠœë¸Œ API ë¡œë“œ
    function loadYouTubeAPI() {
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    // 5. API ì¤€ë¹„ ì™„ë£Œ ì½œë°±
    function onYouTubeIframeAPIReady() {
        // ì´ˆê¸°ì—ëŠ” ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ê³¡ ì„ íƒ ì‹œì—ë§Œ í”Œë ˆì´ì–´ ìƒì„±)
    }

    // í˜„ì¬ ê³¡ íŒì—… ìœˆë„ìš° ì—´ê¸°
    function openCurrentPopupWindow(type) {
        if (type !== 'guitar' || currentSongIdx === -1) return;

        const song = songs[currentSongIdx];
        const videoId = song.guitarId;
        const title = 'ê¸°íƒ€ ì—°ì£¼';
        const windowName = type + '_current_' + Date.now();

        const popup = window.open('', windowName, 'width=900,height=700,scrollbars=no,resizable=yes');

        if (!popup) {
            alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            return;
        }

        // íŒì—… HTML ì‘ì„±
        popup.document.open();
        popup.document.write('<!DOCTYPE html>');
        popup.document.write('<html><head><title>' + title + '</title>');
        popup.document.write('<style>');
        popup.document.write('body{margin:0;padding:0;background:black;overflow:hidden;}');
        popup.document.write('#player{width:100vw;height:100vh;}');
        popup.document.write('.controls{position:fixed;top:10px;right:10px;z-index:1000;background:rgba(0,0,0,0.7);padding:10px;border-radius:5px;}');
        popup.document.write('.btn{background:#ff0000;color:white;border:none;padding:8px 12px;margin:2px;border-radius:3px;cursor:pointer;}');
        popup.document.write('.info{position:fixed;top:10px;left:10px;color:white;background:rgba(0,0,0,0.7);padding:10px;border-radius:5px;font-family:Arial;}');
        popup.document.write('.status{position:fixed;bottom:50px;left:10px;color:yellow;background:rgba(0,0,0,0.8);padding:5px;border-radius:3px;font-family:Arial;font-size:12px;}');
        popup.document.write('</style></head><body>');
        popup.document.write('<div class="controls">');
        popup.document.write('<div style="color:white;margin-bottom:5px;">' + title + '</div>');
        popup.document.write('<button class="btn" onclick="toggleFullscreen()">ì „ì²´í™”ë©´</button>');
        popup.document.write('<button class="btn" onclick="window.close()">ì°½ ë‹«ê¸°</button>');
        popup.document.write('</div>');
        popup.document.write('<div class="info">F11: ì „ì²´í™”ë©´ | ESC: í•´ì œ</div>');
        popup.document.write('<div class="status" id="status">ë¡œë”© ì¤‘...</div>');
        popup.document.write('<div id="player"></div>');
        popup.document.write('</body></html>');
        popup.document.close();

        // íŒì—…ì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
        const script1 = popup.document.createElement('script');
        script1.src = 'https://www.youtube.com/iframe_api';
        popup.document.head.appendChild(script1);

        const script2 = popup.document.createElement('script');
        script2.innerHTML = `
            let player;
            let isReady = false;

            function updateStatus(msg) {
                const el = document.getElementById('status');
                if (el) el.textContent = msg;
            }

            window.onYouTubeIframeAPIReady = function() {
                updateStatus('í”Œë ˆì´ì–´ ìƒì„± ì¤‘...');
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: '${videoId}',
                    playerVars: {
                        'controls': 1,
                        'modestbranding': 1,
                        'rel': 0,
                        'fs': 1,
                        'autoplay': 0
                    },
                    events: {
                        'onReady': function() {
                            isReady = true;
                            updateStatus('í”Œë ˆì´ì–´ ì¤€ë¹„ ì™„ë£Œ');
                            if (window.opener) {
                                window.opener.postMessage({
                                    type: 'popupReady',
                                    windowType: '${type}',
                                    songIdx: 'current'
                                }, '*');
                            }
                            setTimeout(() => {
                                const statusEl = document.getElementById('status');
                                if (statusEl) statusEl.style.display = 'none';
                            }, 2000);
                        }
                    }
                });
            };

            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            document.addEventListener('keydown', function(e) {
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                }
            });

            window.addEventListener('message', function(event) {
                if (event.data.type === 'control' && player && isReady) {
                    try {
                        switch(event.data.action) {
                            case 'play':
                                player.playVideo();
                                break;
                            case 'stop':
                                player.stopVideo();
                                break;
                            case 'seekTo':
                                if (event.data.time !== undefined) {
                                    player.seekTo(event.data.time, true);
                                }
                                break;
                        }
                    } catch (error) {
                        console.error('Control error:', error);
                    }
                }
            });
        `;
        popup.document.head.appendChild(script2);

        currentPopupWindows[type] = {
            window: popup,
            ready: false
        };
    }

    // í˜„ì¬ ê³¡ ë™ì‹œ ì¬ìƒ
    function playCurrentBoth() {
        if (!currentPlayer || currentSongIdx === -1) return;
        
        try {
            currentPlayer.guitar.playVideo();
            setTimeout(() => {
                currentPlayer.bass.playVideo();
            }, Math.abs(currentOffsetSeconds) * 1000);

            // íŒì—…ì—ë„ ì¬ìƒ ì‹ í˜¸
            Object.keys(currentPopupWindows).forEach(type => {
                const popupData = currentPopupWindows[type];
                if (popupData && popupData.window && !popupData.window.closed && popupData.ready) {
                    try {
                        popupData.window.postMessage({ type: 'control', action: 'play' }, '*');
                    } catch (error) {
                        console.error('Message send error:', error);
                    }
                }
            });
        } catch (error) {
            console.log('ì¬ìƒ ì˜¤ë¥˜:', error);
        }
    }

    // í˜„ì¬ ê³¡ ì •ì§€
    function stopCurrentBoth() {
        if (!currentPlayer || currentSongIdx === -1) return;
        
        try {
            currentPlayer.guitar.stopVideo();
            currentPlayer.bass.stopVideo();

            // íŒì—…ì—ë„ ì •ì§€ ì‹ í˜¸
            Object.keys(currentPopupWindows).forEach(type => {
                const popupData = currentPopupWindows[type];
                if (popupData && popupData.window && !popupData.window.closed && popupData.ready) {
                    try {
                        popupData.window.postMessage({ type: 'control', action: 'stop' }, '*');
                    } catch (error) {
                        console.error('Message send error:', error);
                    }
                }
            });
        } catch (error) {
            console.log('ì •ì§€ ì˜¤ë¥˜:', error);
        }
    }

    // í˜„ì¬ ê³¡ ì‹±í¬ ì„¤ì •
    function setCurrentSyncDelay() {
        if (currentSongIdx === -1) return;
        
        const song = songs[currentSongIdx];
        const slider = document.getElementById('syncSlider');
        const valueDisplay = document.getElementById('syncValue');
        
        // ìŠ¬ë¼ì´ë”ë¥¼ ì›ë˜ ê³¡ì˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
        if (slider && valueDisplay) {
            slider.value = song.delay;
            valueDisplay.textContent = song.delay + 'ì´ˆ';
            currentOffsetSeconds = song.delay;
        } else {
            currentOffsetSeconds = song.delay;
        }
    }

    // í˜„ì¬ ê³¡ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    function enableCurrentButtons(enabled) {
        ['currentGuitarPopupBtn', 'currentPlayBtn', 'currentStopBtn', 'currentSyncBtn'].forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.disabled = !enabled;
            }
        });
    }

    // íŒì—… ë©”ì‹œì§€ ìˆ˜ì‹ 
    window.addEventListener('message', function(event) {
        if (event.data.type === 'popupReady' && event.data.songIdx === 'current') {
            const type = event.data.windowType;
            if (currentPopupWindows[type]) {
                currentPopupWindows[type].ready = true;
            }
        }
    });

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
        Object.keys(currentPopupWindows).forEach(type => {
            const popupData = currentPopupWindows[type];
            if (popupData && popupData.window && !popupData.window.closed) {
                popupData.window.close();
            }
        });
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('load', () => {
        loadYouTubeAPI();
        initializeDropdown();
    });
    </script>
</body>
</html>
